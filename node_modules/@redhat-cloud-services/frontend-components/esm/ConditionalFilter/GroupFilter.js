var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useEffect, useRef, useState } from 'react';
import classNames from 'classnames';
import { Button, Checkbox, Menu, MenuContent, MenuGroup, MenuItem, MenuList, MenuToggle, Popper, Radio, TextInput, TreeView, } from '@patternfly/react-core';
import { CloseIcon } from '@patternfly/react-icons';
import { calculateSelected, convertTreeItem, getGroupMenuItems, getMenuItems, isChecked, mapTree, onTreeCheck, } from './groupFilterConstants';
import groupType from './groupType';
import '../ConditionalFilter/group-filter.css';
var GroupFilter = function (_a) {
    var className = _a.className, _b = _a.filterBy, filterBy = _b === void 0 ? '' : _b, _c = _a.groups, groups = _c === void 0 ? [] : _c, items = _a.items, _d = _a.isFilterable, isFilterable = _d === void 0 ? false : _d, onFilter = _a.onFilter, onChange = _a.onChange, onShowMore = _a.onShowMore, placeholder = _a.placeholder, selected = _a.selected, showMoreTitle = _a.showMoreTitle, showMoreOptions = _a.showMoreOptions, isDisabled = _a.isDisabled;
    var _e = useState({}), stateSelected = _e[0], setStateSelected = _e[1];
    var _f = useState(''), searchString = _f[0], setSearchString = _f[1];
    var _g = useState(false), isOpen = _g[0], setIsOpen = _g[1];
    var toggleRef = useRef(null);
    var containerRef = useRef(null);
    var menuRef = useRef(null);
    var inputRef = useRef(null);
    useEffect(function () {
        selected && setStateSelected(selected);
    }, [selected]);
    useEffect(function () {
        setSearchString(filterBy);
    }, [filterBy]);
    var handleMenuKeys = function (event) {
        var _a, _b, _c;
        if (!isOpen) {
            return;
        }
        if (((_a = menuRef.current) === null || _a === void 0 ? void 0 : _a.contains(event.target)) || ((_b = toggleRef.current) === null || _b === void 0 ? void 0 : _b.contains(event.target))) {
            if (event.key === 'Escape' || event.key === 'Enter') {
                setIsOpen(!isOpen);
                (_c = toggleRef.current) === null || _c === void 0 ? void 0 : _c.focus();
            }
        }
    };
    var handleClickOutside = function (event) {
        var _a;
        if (isOpen && !((_a = menuRef.current) === null || _a === void 0 ? void 0 : _a.contains(event.target))) {
            setIsOpen(false);
        }
    };
    useEffect(function () {
        window.addEventListener('keydown', handleMenuKeys);
        window.addEventListener('click', handleClickOutside);
        return function () {
            window.removeEventListener('keydown', handleMenuKeys);
            window.removeEventListener('click', handleClickOutside);
        };
    }, [isOpen, menuRef]);
    var onToggleClick = function (ev) {
        ev.stopPropagation();
        ev.persist();
        setIsOpen(!isOpen);
    };
    var menuItems = getMenuItems((items === null || items === void 0 ? void 0 : items.map(function (item) { return (item.type === groupType.treeView ? convertTreeItem(item) : item); })) || [], onChange, calculateSelected(selected || {}));
    var groupMenuItems = getGroupMenuItems(groups, onChange, calculateSelected(selected || {}));
    var renderItem = function (item, key, type, groupKey) {
        if (groupKey === void 0) { groupKey = ''; }
        return (_jsx(MenuItem, __assign({ itemId: key, className: item === null || item === void 0 ? void 0 : item.className, onClick: item.onClick && (type || item.type) === groupType.checkbox
                ? function (e) {
                    item.onClick && item.onClick();
                    e.preventDefault();
                }
                : undefined }, { children: (type || item.type) === groupType.treeView ? (_jsx(TreeView, { data: [mapTree(item, groupKey, stateSelected, selected || {})], onCheck: function (e, value) { return onTreeCheck(e, value, [item]); }, hasChecks: true })) : (type || item.type) === groupType.checkbox ? (_jsx(Checkbox, __assign({}, item, { label: item === null || item === void 0 ? void 0 : item.label, isChecked: (item === null || item === void 0 ? void 0 : item.isChecked) || isChecked(groupKey, (item === null || item === void 0 ? void 0 : item.value) || key, item === null || item === void 0 ? void 0 : item.id, item === null || item === void 0 ? void 0 : item.tagValue, stateSelected, selected || {}) || false, onChange: function (value, event) {
                    var _a;
                    (_a = item === null || item === void 0 ? void 0 : item.onChange) === null || _a === void 0 ? void 0 : _a.call(item, value, event);
                }, onClick: item.onClick
                    ? function (e) {
                        item.onClick && item.onClick();
                        e.stopPropagation();
                    }
                    : undefined, name: (item === null || item === void 0 ? void 0 : item.name) || (item === null || item === void 0 ? void 0 : item.value) || "".concat(groupKey, "-").concat(key), id: (item === null || item === void 0 ? void 0 : item.id) || (item === null || item === void 0 ? void 0 : item.value) || "".concat(groupKey, "-").concat(key) }))) : (type || item.type) === groupType.radio ? (_jsx(Radio, __assign({}, item, { isChecked: (item === null || item === void 0 ? void 0 : item.isChecked) || isChecked(groupKey, (item === null || item === void 0 ? void 0 : item.value) || key, item === null || item === void 0 ? void 0 : item.id, item === null || item === void 0 ? void 0 : item.tagValue, stateSelected, selected || {}) || false, onChange: function (value, event) {
                    var _a;
                    (_a = item === null || item === void 0 ? void 0 : item.onChange) === null || _a === void 0 ? void 0 : _a.call(item, value, event);
                }, value: (item === null || item === void 0 ? void 0 : item.value) || key, name: (item === null || item === void 0 ? void 0 : item.name) || (item === null || item === void 0 ? void 0 : item.value) || "".concat(groupKey, "-").concat(key), label: (item === null || item === void 0 ? void 0 : item.label) || '', id: (item === null || item === void 0 ? void 0 : item.id) || (item === null || item === void 0 ? void 0 : item.value) || "".concat(groupKey, "-").concat(key) }))) : (type || item.type) === groupType.button ? (_jsx(Button, __assign({ id: item.id, className: "pf-c-select__option-button ".concat((item === null || item === void 0 ? void 0 : item.className) || ''), variant: item === null || item === void 0 ? void 0 : item.variant, onClick: item.onClick }, { children: item === null || item === void 0 ? void 0 : item.label }))) : ((item === null || item === void 0 ? void 0 : item.label) || '') }), "".concat(item.value, "-").concat(key, "-item")));
    };
    var renderItems = function (items, type, groupKey) {
        if (groupKey === void 0) { groupKey = ''; }
        return items.map(function (item, key) {
            return (type || item.type) === groupType.treeView ? (_jsx("div", __assign({ className: "ins-c-tree-view" }, { children: renderItem(item, key, type, groupKey) }), "".concat(item.value, "-").concat(key, "-item"))) : (renderItem(item, key, type, groupKey));
        });
    };
    var hasFocus = document.activeElement === inputRef.current || document.activeElement === toggleRef.current;
    var searchDirty = hasFocus && (searchString === null || searchString === void 0 ? void 0 : searchString.length) > 0;
    var setFilter = function (value) {
        setSearchString(value);
        onFilter === null || onFilter === void 0 ? void 0 : onFilter(value);
    };
    return (_jsx("div", __assign({ ref: containerRef }, { children: _jsx(Popper, { appendTo: containerRef.current, trigger: _jsx(MenuToggle, __assign({ "aria-label": "Group filter", ref: toggleRef, onClick: function (e) { return onToggleClick(e); }, isExpanded: isOpen, className: className, isDisabled: isDisabled }, { children: isFilterable || onFilter ? (_jsxs("div", { children: [_jsx(TextInput, { ref: inputRef, className: classNames({
                                'ins-c-input__clearable': searchDirty,
                            }), onChange: function (value) { return setFilter(value); }, onClick: function (e) { return e.preventDefault(); }, onKeyDown: function (e) {
                                if (e.key === ' ' || e.key === 'Escape') {
                                    e.preventDefault();
                                    setFilter(e.key === ' ' ? "".concat(searchString, " ") : '');
                                    e.key === 'Escape' && setIsOpen(false);
                                }
                            }, isDisabled: isDisabled, "aria-label": "input with dropdown and clear button", placeholder: placeholder, value: searchString, tabIndex: 0, type: "text" }), searchDirty && (_jsx("span", __assign({ className: "ins-c-icon__link" }, { children: _jsx(CloseIcon, { onClick: function () {
                                    setFilter('');
                                    setIsOpen(false);
                                } }) })))] })) : (placeholder) })), popper: _jsx(Menu, __assign({ ref: menuRef, className: classNames('ins-c-menu__scrollable', className, { 'pf-m-expanded': isOpen }) }, { children: _jsx(MenuContent, { children: _jsxs(MenuList, __assign({ "aria-label": "Group filter" }, { children: [menuItems.length > 0 && _jsx(MenuGroup, { children: renderItems(menuItems) }), groupMenuItems.map(function (group, groupKey) { return (_jsx(MenuGroup, __assign({ label: !group.groupSelectable && typeof group.label === 'string' ? group.label : undefined }, { children: renderItems(group.items, group.type, group.value) }), "".concat(group.label, "-").concat(groupKey, "-group"))); }), onShowMore ? (_jsx(MenuItem, __assign({ itemId: "loader", className: "ins-c-menu__show--more" }, showMoreOptions, { onClick: function (e) { return onShowMore(e); } }, { children: showMoreTitle }))) : (_jsx("span", { hidden: true, value: "" }))] })) }) })), isVisible: isOpen }) })));
};
export default GroupFilter;
//# sourceMappingURL=GroupFilter.js.map